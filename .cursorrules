# AskSharon.ai Development Rules (Python Edition)

## Core Philosophy
1. **Automate everything** - Setup, tests, deployments, health checks
2. **Fail loudly with clarity** - Structured logging, notifications
3. **Recover automatically** - Retry logic, graceful degradation
4. **Document decisions** - DECISIONS.md for all choices

## AI Workflow (MANDATORY)
**Before any substantial code change, AI MUST:**
1. Read `docs/principles.md`, `docs/ENGINEERING_GUIDELINES.md`, `docs/AI_WORKFLOW.md`
2. Follow **Plan → Implement → Self-review** workflow
3. Run `python tools/check_architecture.py` before claiming complete
4. Verify code passes: pytest, black, mypy

## UI Testing Rules (Streamlit, MANDATORY for New Features)
**When adding or changing Streamlit UI features (new button, form, page, or behavior):**
1. **MUST create** Playwright E2E test in `tests/e2e/test_<feature>_ui.py`
2. **Test must verify:**
   - Element exists and is visible
   - Interaction works (click, fill, submit)
   - Correct result appears in UI
   - No error state (unless expected)
3. **MUST execute test** and show passing output:
   - Run: `pytest tests/e2e/test_<feature>_ui.py -v`
   - Show test code + passing results
4. **Forbidden:**
   - ❌ Claiming "UI works" without passing E2E test
   - ❌ Writing test but not running it
   - ❌ Trivial tests (goto-only, no assertions)
5. **Config location:** `tests/e2e/conftest.py` (use existing, don't create duplicate)
6. **Strictness:** MEDIUM - Test required, human judges adequacy
7. **See:** `docs/UI_TESTING_STANDARDS.md` for full guide

## The 26 Fundamental Rules

### Rules 1-3: Module Architecture
1. **Register() Contract** - All modules: `register(app, publish, subscribe)`
2. **Keep Modules Small** - <200 lines, break into files
3. **Document Modules** - Docstrings: purpose, events, dependencies

### Rules 4-7: API & Performance
4. **FastAPI Patterns** - Async, Pydantic, standardized responses
5. **Response < 200ms** - Async, caching, pagination
6. **Stream Long Operations** - SSE for AI/external APIs
7. **Document APIs** - Docstrings with examples

### Rules 8-12: Database & Error Handling
8. **SQLAlchemy + Type Hints** - Typed models, async queries
9. **Preserve Functionality** - Test before/after changes
10. **Comprehensive Errors** - Try/except + error_handler.handle()
11. **Optimize Queries** - Indexes, EXPLAIN, limit results
12. **Code Passes Checks** - pytest + black + mypy

### Rules 13-17: Security & Types
13. **Type Hints Everywhere** - Functions, classes, returns
14. **Validate Inputs** - Pydantic models for all inputs
15. **Structured Logging** - JSON logs with context
16. **Rate Limiting** - Prevent abuse on all endpoints
17. **Validate Env Vars** - Fail fast on startup if missing

### Rules 18-23: Process (Inherited)
18. **Plan Before Coding** - Document in DECISIONS.md
19. **Use Tech Stack** - FastAPI, Streamlit, SQLite, FAISS
20. **Consistent Patterns** - Reuse existing code styles
21. **Specify Files** - Exact paths for changes
22. **Flat Structure** - assistant/modules/name/main.py
23. **Efficient Communication** - Comprehensive messages

### Rules 24-27: Automation & Notifications (NEW)
24. **Automate Everything**
    - Setup: `./scripts/setup.sh` one-command
    - Tests: `./scripts/test_all.sh` all suites
    - Health: `/health` endpoint + health_check.py
    - Deployment: Automated with rollback

25. **Proactive Notifications**
    - Module events: Load success/failure
    - User events: Morning check-in, goal progress
    - Admin alerts: Critical errors, rate spikes
    - Console + logs + event bus

26. **Self-Healing Errors**
    - Automatic retry with exponential backoff
    - Graceful degradation (AI → fallback)
    - Error queues for failed operations
    - Recovery notifications

27. **Verify UI Interactions with E2E Tests**
    - Before confirming buttons/links work, run Playwright tests
    - Create specific tests for each interactive element
    - Verify: Element exists → Click works → Backend called → Correct response
    - Capture screenshots for visual verification
    - Test must pass before claiming "feature works"
    - Pattern: `pytest tests/test_button_clicks.py::test_<feature>_button_actually_works`

## Error Handling Pattern
```python
from assistant.core.error_handler import error_handler, ErrorSeverity
from assistant.core.notifier import notifier, NotificationLevel

try:
    result = await risky_operation()
    notifier.notify("user", "✅ Success", NotificationLevel.INFO)
    return {"success": True, "data": result}

except KnownError as e:
    return error_handler.handle(
        module="module_name",
        error=e,
        severity=ErrorSeverity.MEDIUM,
        user_message="Clear user message",
        retry=True
    )
```

## Module Template
```python
"""
Module Name
===========
Purpose: [What it does]
Events: [Publishes/subscribes]
Dependencies: [External services]
"""

from fastapi import APIRouter
from assistant.core.notifier import notifier

router = APIRouter()

def register(app, publish, subscribe):
    \"\"\"Register module with orchestrator\"\"\"
    app.include_router(router, prefix="/module")
    subscribe("event_name", handle_event)
    notifier.notify("system", "✅ Module loaded")

def handle_event(data):
    \"\"\"Handle subscribed events\"\"\"
    pass

@router.get("/endpoint")
async def endpoint():
    \"\"\"
    Endpoint description

    Returns:
        { "success": bool, "data": any }
    \"\"\"
    return {"success": True, "data": None}
```

## Checklist Before Commit
- [ ] Follows Rules 1-27
- [ ] pytest passes
- [ ] black formatting applied
- [ ] mypy type checks pass
- [ ] Error handling implemented
- [ ] Notifications added
- [ ] Docstrings complete
- [ ] Decision logged in DECISIONS.md
- [ ] Playwright E2E tests pass (for UI changes)
